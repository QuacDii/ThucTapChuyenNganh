@model TTCN.Models.SuatChieu

@{
    ViewData["Title"] = "Thêm Suất Chiếu";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="container-fluid">
    <div class="card shadow mb-4" style="max-width: 800px; margin: 0 auto;">
        <div class="card-header py-3 bg-white border-bottom-primary">
            <h5 class="m-0 font-weight-bold text-primary">Thêm Suất Chiếu Mới</h5>
        </div>
        <div class="card-body">
            <form asp-action="them" id="createForm">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <!-- HÀNG 1: CHỌN PHIM -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group mb-3">
                            <label class="control-label font-weight-bold">Chọn Phim</label>
                            <select asp-for="MaPhim" class="form-control" asp-items="ViewBag.MaPhim" id="selectPhim">
                                <option value="">-- Vui lòng chọn phim --</option>
                            </select>
                            <span asp-validation-for="MaPhim" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- HÀNG 2: CHỌN CỤM RẠP & PHÒNG -->
                <div class="row">
                    <!-- 1. Dropdown Cụm Rạp -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="control-label font-weight-bold">Chọn Cụm Rạp</label>
                            <select id="selectCumRap" class="form-control" asp-items="ViewBag.ListCumRap">
                                <option value="">-- Tất cả cụm rạp --</option>
                            </select>
                        </div>
                    </div>

                    <!-- 2. Dropdown Phòng Chiếu  -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="control-label font-weight-bold">Chọn Phòng Chiếu</label>
                            <select asp-for="MaPhong" class="form-control" id="selectPhong" asp-items="ViewBag.MaPhong">
                                <option value="">-- Vui lòng chọn cụm rạp trước --</option>
                            </select>
                            <span asp-validation-for="MaPhong" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- HÀNG 3: GIÁ VÉ -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group mb-3">
                            <label asp-for="Gia" class="control-label font-weight-bold">Giá Suất Cơ Bản</label>
                            <div class="input-group">
                                <input asp-for="Gia" class="form-control" type="number" min="0" step="1000" placeholder="Ví dụ: 50000" />
                                <span class="input-group-text fw-bold">VNĐ</span>
                            </div>
                            <span asp-validation-for="Gia" class="text-danger"></span>
                            <small class="text-muted fst-italic">* Đây là giá gốc cho ghế thường.</small>
                        </div>
                    </div>
                </div>

                <!-- HÀNG 4: NGÀY GIỜ -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label asp-for="GioBatDau" class="control-label font-weight-bold">Giờ Bắt Đầu</label>
                            <input asp-for="GioBatDau" class="form-control bg-white" type="text" id="gioBatDau" placeholder="Chọn ngày giờ.." />
                            <span asp-validation-for="GioBatDau" class="text-danger"></span>
                            <small class="text-muted fst-italic" id="rangeDateHint"></small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label asp-for="GioKetThuc" class="control-label font-weight-bold">Giờ Kết Thúc</label>
                            <input asp-for="GioKetThuc" class="form-control bg-light" type="text" id="gioKetThuc" tabindex="-1" />
                            <span asp-validation-for="GioKetThuc" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a asp-action="Index" class="btn btn-secondary px-4 mr-2">
                        <i class="fas fa-arrow-left mr-1"></i> Quay lại
                    </a>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="fas fa-save mr-1"></i> Lưu lại
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- CẤU HÌNH FLATPICKR ---
             const config = {
                enableTime: true,
                dateFormat: "Y-m-d\\TH:i",
                altInput: true,
                altFormat: "d/m/Y H:i",
                time_24hr: true,
                allowInput: false
            };

            const startPicker = flatpickr("#gioBatDau", {
                ...config,
                onChange: function(selectedDates, dateStr, instance) {
                    calculateEndTime(selectedDates[0]);
                }
            });

            const endPicker = flatpickr("#gioKetThuc", {
                ...config,
                clickOpens: false
            });

            var selectPhim = document.getElementById('selectPhim');
            var selectCumRap = document.getElementById('selectCumRap'); 
            var selectPhong = document.getElementById('selectPhong');   
            var rangeHint = document.getElementById('rangeDateHint');
            var currentDuration = 0;

            // --- LOGIC 1: XỬ LÝ CHỌN PHIM (Lấy thời lượng & ngày chiếu) ---
            selectPhim.addEventListener('change', function () {
                var phimId = this.value;
                if (phimId) {
                    fetch('/SuatChieu/getPhim?id=' + phimId)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                currentDuration = data.thoiLuong || 0;
                                startPicker.set('minDate', data.ngayPhatHanh);
                                startPicker.set('maxDate', data.ngayKetThuc);

                                let d1 = formatDateVN(data.ngayPhatHanh);
                                let d2 = formatDateVN(data.ngayKetThuc);
                                rangeHint.innerText = `* Phim chiếu từ ${d1} đến ${d2} (${currentDuration} phút)`;

                                if (startPicker.selectedDates[0]) {
                                    calculateEndTime(startPicker.selectedDates[0]);
                                }
                            }
                        })
                        .catch(err => console.error(err));
                } else {
                    currentDuration = 0;
                    rangeHint.innerText = "";
                    startPicker.clear();
                }
            });

            // --- LOGIC 2: XỬ LÝ CHỌN CỤM RẠP (Lọc phòng chiếu) ---
            selectCumRap.addEventListener('change', function () {
                var cumRapId = this.value;

                // Xóa danh sách phòng cũ
                selectPhong.innerHTML = '<option value="">-- Vui lòng chọn phòng --</option>';

                if (cumRapId) {
                    // Gọi API lấy danh sách phòng theo cụm rạp
                    fetch('/SuatChieu/GetPhongByCumRap?id=' + cumRapId)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length > 0) {
                                data.forEach(item => {
                                    var option = document.createElement('option');
                                    option.value = item.maPhong;
                                    option.text = item.tenPhong;
                                    selectPhong.appendChild(option);
                                });
                            } else {
                                var option = document.createElement('option');
                                option.text = "Không có phòng chiếu nào";
                                selectPhong.appendChild(option);
                            }
                        })
                        .catch(err => console.error(err));
                }
            });
            function calculateEndTime(startDate) {
                if (startDate && currentDuration > 0) {
                    var endTimeMs = startDate.getTime() + (currentDuration * 60000);
                    var endTime = new Date(endTimeMs);
                    endPicker.setDate(endTime);
                }
            }

            function formatDateVN(isoString) {
                if (!isoString) return '...';
                const date = new Date(isoString);
                return date.toLocaleDateString('vi-VN');
            }
        });
    </script>
}