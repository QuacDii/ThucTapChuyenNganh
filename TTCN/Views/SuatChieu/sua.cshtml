@model TTCN.Models.SuatChieu

@{
    ViewData["Title"] = "Cập nhật Suất Chiếu";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="container-fluid">
    <div class="card shadow mb-4" style="max-width: 800px; margin: 0 auto;">
        <div class="card-header py-3 bg-white border-bottom-primary">
            <h5 class="m-0 font-weight-bold text-primary">Cập nhật Suất Chiếu</h5>
        </div>
        <div class="card-body">
            <form asp-action="sua" id="editForm">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                <input type="hidden" asp-for="MaSuat" />

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group mb-3">
                            <label class="control-label font-weight-bold">Chọn Phim</label>
                            <select asp-for="MaPhim" class="form-control" asp-items="ViewBag.MaPhim" id="selectPhim">
                                <option value="">-- Vui lòng chọn phim --</option>
                            </select>
                            <span asp-validation-for="MaPhim" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="control-label font-weight-bold">Cụm Rạp</label>
                            <input type="text" class="form-control bg-light" readonly id="cinemaInput"
                                   value="@(Model.MaPhongNavigation?.MaCumRapNavigation?.TenCumRap ?? "Chưa chọn")" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="control-label font-weight-bold">Chọn Phòng Chiếu</label>
                            <select asp-for="MaPhong" class="form-control" asp-items="ViewBag.MaPhong" id="selectPhong"></select>
                            <span asp-validation-for="MaPhong" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group mb-3">
                            <label asp-for="Gia" class="control-label font-weight-bold">Giá Suất Cơ Bản</label>
                            <div class="input-group">
                                <input asp-for="Gia" class="form-control" type="number" min="0" step="1000" placeholder="Ví dụ: 50000" />
                                <span class="input-group-text fw-bold">VNĐ</span>
                            </div>
                            <span asp-validation-for="Gia" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label asp-for="GioBatDau" class="control-label font-weight-bold">Giờ Bắt Đầu</label>
                            <input asp-for="GioBatDau" class="form-control bg-white" type="text" id="gioBatDau"
                                   value="@(Model.GioBatDau?.ToString("yyyy-MM-ddTHH:mm"))" placeholder="Chọn ngày giờ.." />
                            <span asp-validation-for="GioBatDau" class="text-danger"></span>
                            <small class="text-muted fst-italic" id="rangeDateHint"></small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label asp-for="GioKetThuc" class="control-label font-weight-bold">Giờ Kết Thúc</label>
                            <input asp-for="GioKetThuc" class="form-control bg-light" type="text" id="gioKetThuc" tabindex="-1"
                                   value="@(Model.GioKetThuc?.ToString("yyyy-MM-ddTHH:mm"))" />
                            <span asp-validation-for="GioKetThuc" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a asp-action="Index" class="btn btn-secondary px-4 mr-2">
                        <i class="fas fa-arrow-left mr-1"></i> Quay lại
                    </a>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="fas fa-save mr-1"></i> Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 1. Lấy dữ liệu Map từ ViewBag (được in ra dưới dạng JSON)
            var roomMap = @Html.Raw(ViewBag.RoomCinemaJson);

            var selectPhong = document.getElementById('selectPhong');
            var cinemaInput = document.getElementById('cinemaInput');

            // 2. Sự kiện khi đổi phòng -> Cập nhật tên rạp
            selectPhong.addEventListener('change', function() {
                var roomId = this.value;
                if(roomId && roomMap[roomId]) {
                    cinemaInput.value = roomMap[roomId];
                } else {
                    cinemaInput.value = "Không xác định";
                }
            });

            // --- CÁC LOGIC CŨ (LỊCH CHIẾU, PHIM) GIỮ NGUYÊN ---
            const config = {
                enableTime: true,
                dateFormat: "Y-m-d\\TH:i",
                altInput: true,
                altFormat: "d/m/Y H:i",
                time_24hr: true,
                allowInput: false
            };

            const startPicker = flatpickr("#gioBatDau", {
                ...config,
                onChange: function(selectedDates, dateStr, instance) {
                    calculateEndTime(selectedDates[0]);
                }
            });

            const endPicker = flatpickr("#gioKetThuc", {
                ...config,
                clickOpens: false
            });

            var selectPhim = document.getElementById('selectPhim');
            var rangeHint = document.getElementById('rangeDateHint');
            var currentDuration = 0;

            var initialPhimId = selectPhim.value;
            if(initialPhimId) {
                loadPhimInfo(initialPhimId, false);
            }

            selectPhim.addEventListener('change', function () {
                var phimId = this.value;
                if (phimId) {
                    loadPhimInfo(phimId, true);
                } else {
                    resetForm();
                }
            });

            function loadPhimInfo(phimId, shouldResetDate) {
                fetch('/SuatChieu/GetThongTinPhim?id=' + phimId)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            currentDuration = data.thoiLuong || 0;
                            startPicker.set('minDate', data.ngayPhatHanh);
                            startPicker.set('maxDate', data.ngayKetThuc);

                            let d1 = formatDateVN(data.ngayPhatHanh);
                            let d2 = formatDateVN(data.ngayKetThuc);
                            rangeHint.innerText = `* Phim chiếu từ ${d1} đến ${d2} (${currentDuration} phút)`;

                            if (shouldResetDate) {
                                startPicker.clear();
                                endPicker.clear();
                            }
                        }
                    })
                    .catch(err => console.error(err));
            }

            function calculateEndTime(startDate) {
                if (startDate && currentDuration > 0) {
                    var endTimeMs = startDate.getTime() + (currentDuration * 60000);
                    var endTime = new Date(endTimeMs);
                    endPicker.setDate(endTime);
                }
            }

            function resetForm() {
                currentDuration = 0;
                rangeHint.innerText = "";
                startPicker.clear();
                endPicker.clear();
                startPicker.set('minDate', null);
                startPicker.set('maxDate', null);
            }

            function formatDateVN(isoString) {
                if (!isoString) return '...';
                const date = new Date(isoString);
                return date.toLocaleDateString('vi-VN');
            }
        });
    </script>
}